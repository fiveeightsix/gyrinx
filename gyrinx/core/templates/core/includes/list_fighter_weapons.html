{% load allauth custom_tags %}
{% if mode == 'add' %}
    {% for assign in weapons %}
        <form action="{% url 'core:list-fighter-weapons-edit' list.id fighter.id %}{% querystring flash=None %}"
              method="post"
              id="weapon-{{ assign.equipment.id }}"
              class="d-none">
            {% csrf_token %}
            <input type="hidden"
                   name="content_equipment"
                   value="{{ assign.equipment.id }}">
            {% comment %} Propagate the query params {% endcomment %}
            {% if request.GET.filter %}<input type="hidden" name="filter" value="{{ request.GET.filter }}">{% endif %}
            {% if request.GET.q %}<input type="hidden" name="q" value="{{ request.GET.q }}">{% endif %}
        </form>
    {% endfor %}
{% endif %}
<table class="table table-sm table-borderless mb-0 fs-7">
    <thead class="table-group-divider">
        <tr>
            <th scope="col">
                Weapons
                {% if mode == "gear" %}
                    <a href="{% url 'core:list-fighter-weapons-edit' list.id fighter.id %}{% querystring %}"
                       class="fw-normal">Edit weapons</a>
                {% endif %}
            </th>
            <th class="text-center" scope="col">S</th>
            <th class="text-center" scope="col">L</th>
            <th class="text-center border-start" scope="col">S</th>
            <th class="text-center" scope="col">L</th>
            <th class="text-center border-start" scope="col">Str</th>
            <th class="text-center" scope="col">Ap</th>
            <th class="text-center" scope="col">D</th>
            <th class="text-center" scope="col">Am</th>
            {% if mode == 'add' %}<th class="text-center border-start" scope="col">AL</th>{% endif %}
        </tr>
    </thead>
    {% for assign in weapons %}
        <tbody class="table-group-divider {% flash assign.id %}"
               id="assign-{{ assign.id }}">
            <!-- {{ assign.id }} ({{ assign.kind }}) -->
            {% include "core/includes/list_fighter_weapon_rows.html" with list=list fighter=fighter assign=assign mode=mode %}
            {% if mode == 'add' %}
                {% if assign.upgrades_display|length > 0 %}
                    <tr>
                        <td colspan="9">{% include "core/includes/list_fighter_weapon_assign_upgrade_form.html" with assign=assign %}</td>
                    </tr>
                {% endif %}
            {% endif %}
            {% if mode == 'add' %}
                <tr>
                    <td colspan="10">
                        <div class="d-flex btn-group">
                            <button type="submit"
                                    class="btn btn-outline-primary btn-sm"
                                    form="weapon-{{ assign.equipment.id }}">
                                <i class="bi-plus"></i>
                                Add {{ assign.base_name }}
                            </button>
                        </div>
                    </td>
                </tr>
            {% endif %}
            {% if mode == 'edit' %}
                <tr>
                    <td colspan="9" class="text-end">
                        <div class="d-flex">
                            {% if assign.kind == 'assigned' %}
                                <div class="btn-group">
                                    <a href="{% url 'core:list-fighter-weapon-accessories-edit' list.id fighter.id assign.id %}"
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="bi-crosshair"></i>
                                        Accessories
                                    </a>
                                    {% if assign.upgrades_display|length > 0 %}
                                        <a href="{% url 'core:list-fighter-weapon-upgrade-edit' list.id fighter.id assign.id %}"
                                           class="btn btn-outline-secondary btn-sm">
                                            <i class="bi-arrow-up-circle"></i>
                                            <span class="d-none d-sm-inline">{{ assign.equipment.upgrade_stack_name }}</span>
                                        </a>
                                    {% endif %}
                                    {% if fighter.is_stash and list.status == 'campaign_mode' %}
                                        <a href="{% url 'core:list-fighter-equipment-sell' list.id fighter.id assign.id %}?sell_assign={{ assign.id }}"
                                           class="btn btn-outline-secondary btn-sm">
                                            <i class="bi-coin"></i> Sell All
                                        </a>
                                    {% endif %}
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a href="{% url 'core:list-fighter-weapon-cost-edit' list.id fighter.id assign.id %}"
                                                   class="dropdown-item">
                                                    <i class="bi-pencil"></i> Cost
                                                </a>
                                            </li>
                                            <li>
                                                <a href="{% url 'core:list-fighter-weapon-reassign' list.id fighter.id assign.id %}"
                                                   class="dropdown-item">
                                                    <i class="bi-arrow-left-right"></i> Reassign
                                                </a>
                                            </li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li>
                                                <a href="{% url 'core:list-fighter-weapon-delete' list.id fighter.id assign.id %}"
                                                   class="dropdown-item text-danger">
                                                    <i class="bi-trash"></i> Delete
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            {% elif assign.kind == 'default' %}
                                <div class="btn-group">
                                    <a href="{% url 'core:list-fighter-weapons-default-convert' list.id fighter.id assign.id %}"
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="bi-pencil"></i>
                                        Modify from default
                                    </a>
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a href="{% url 'core:list-fighter-weapons-default-disable' list.id fighter.id assign.id %}"
                                                   class="dropdown-item text-danger">
                                                    <i class="bi-trash"></i> Delete
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    {% empty %}
        <tbody>
            <tr>
                <td colspan="9">
                    <span class="text-secondary">{{ fighter.proximal_demonstrative }} has no weapons.</span>
                </td>
            </tr>
        </tbody>
    {% endfor %}
</table>
